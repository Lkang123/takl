<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ‚„æ‚„è¯</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        width: 100%;
        height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow: hidden;
      }

      /* ä¸»å®¹å™¨ï¼šå®Œå…¨å¡«å……è§†å£ */
      #app {
        width: 100%;
        max-width: 800px;
        height: var(--app-vh, 100vh);
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        background: #f2f2f7;
        position: relative;
      }

      /* é¡¶éƒ¨å¯¼èˆªæ  */
      header {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: rgba(242, 242, 247, 0.95);
        backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 0.5px solid rgba(60, 60, 67, 0.12);
        z-index: 10;
      }

      header .title {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      header h1 {
        font-size: 17px;
        font-weight: 600;
        color: #000;
        letter-spacing: -0.4px;
      }

      header .subtitle {
        font-size: 12px;
        color: #8e8e93;
        font-weight: 400;
      }

      header .status-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #34c759;
        font-weight: 500;
      }

      header .status-indicator::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #34c759;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* åœ¨çº¿äººæ•° */
      header .user-count {
        font-size: 13px;
        color: #8e8e93;
        font-weight: 500;
      }

      /* è®¤è¯ç•Œé¢ */
      #auth {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 32px 20px;
        background: #fff;
      }

      #auth .lock-icon {
        font-size: 48px;
        margin-bottom: 24px;
        opacity: 0.8;
      }

      #auth .row {
        width: 100%;
        max-width: 320px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      #auth label {
        font-size: 15px;
        color: #000;
        font-weight: 500;
      }

      #auth input {
        width: 100%;
        padding: 14px 16px;
        border: none;
        border-radius: 12px;
        background: #f2f2f7;
        font-size: 17px;
        outline: none;
        transition: background 0.2s;
      }

      #auth input:focus {
        background: #e5e5ea;
      }

      #auth button {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 12px;
        background: #007aff;
        color: #fff;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.1s;
        margin-top: 8px;
      }

      #auth button:hover {
        opacity: 0.9;
      }

      #auth button:active {
        opacity: 0.7;
        transform: scale(0.98);
      }

      #auth .status-text {
        margin-top: 12px;
        font-size: 14px;
        color: #ff3b30;
        text-align: center;
        min-height: 20px;
      }

      /* èŠå¤©ä¸»ç•Œé¢å®¹å™¨ */
      #chat {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        min-height: 0;
        background: #fff;
      }

      /* æ˜µç§°ç¼–è¾‘æ  */
      .name-bar {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        background: #f2f2f7;
        border-bottom: 0.5px solid rgba(60, 60, 67, 0.12);
      }

      .name-bar label {
        font-size: 14px;
        color: #8e8e93;
        font-weight: 500;
        white-space: nowrap;
      }

      .name-bar input {
        flex: 1 1 auto;
        padding: 9px 12px;
        border: none;
        border-radius: 8px;
        background: #fff;
        font-size: 16px;
        outline: none;
        transition: box-shadow 0.2s;
      }

      .name-bar input:focus {
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
      }

      /* æ¶ˆæ¯æ»šåŠ¨åŒºåŸŸ */
      #messages {
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 16px;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 10px;
        -webkit-overflow-scrolling: touch;
      }

      /* ç³»ç»Ÿæ¶ˆæ¯ */
      #messages .system {
        align-self: center;
        color: #8e8e93;
        font-size: 13px;
        text-align: center;
        padding: 6px 12px;
        background: rgba(142, 142, 147, 0.08);
        border-radius: 12px;
        max-width: 80%;
      }

      /* æ¶ˆæ¯æ°”æ³¡å®¹å™¨ */
      #messages .msg {
        display: flex;
        flex-direction: column;
        animation: slideIn 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(8px) scale(0.96);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      #messages .msg.left {
        align-items: flex-start;
      }

      #messages .msg.right {
        align-items: flex-end;
      }

      /* æ˜µç§°æ ‡ç­¾ */
      #messages .msg .name {
        font-size: 12px;
        color: #8e8e93;
        margin-bottom: 4px;
        padding: 0 4px;
        font-weight: 500;
      }

      /* æ¶ˆæ¯æ°”æ³¡ */
      #messages .msg .bubble {
        max-width: 75%;
        min-width: 48px;
        padding: 10px 14px;
        border-radius: 18px;
        word-wrap: break-word;
        word-break: break-word;
        line-height: 1.42;
        font-size: 16px;
        position: relative;
      }

      #messages .msg.left .bubble {
        background: #e9e9eb;
        color: #000;
        border-bottom-left-radius: 4px;
      }

      #messages .msg.right .bubble {
        background: #007aff;
        color: #fff;
        border-bottom-right-radius: 4px;
      }

      /* åº•éƒ¨è¾“å…¥æ  */
      form {
        flex: 0 0 auto;
        display: flex;
        align-items: flex-end;
        gap: 8px;
        padding: 10px 16px;
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
        background: #f2f2f7;
        border-top: 0.5px solid rgba(60, 60, 67, 0.12);
      }

      #input {
        flex: 1 1 auto;
        min-height: 36px;
        max-height: 100px;
        padding: 8px 14px;
        border: none;
        border-radius: 18px;
        background: #fff;
        font-size: 16px;
        line-height: 1.4;
        outline: none;
        resize: none;
        font-family: inherit;
        transition: box-shadow 0.2s;
      }

      #input:focus {
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.15);
      }

      form button {
        flex: 0 0 auto;
        padding: 8px 18px;
        border: none;
        border-radius: 18px;
        background: #007aff;
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.1s;
        white-space: nowrap;
        min-height: 36px;
      }

      form button:hover {
        opacity: 0.9;
      }

      form button:active {
        opacity: 0.7;
        transform: scale(0.96);
      }

      /* æ»šåŠ¨æ¡æ ·å¼ (webkit) */
      #messages::-webkit-scrollbar {
        width: 4px;
      }
      #messages::-webkit-scrollbar-track {
        background: transparent;
      }
      #messages::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
        border-radius: 2px;
      }
      #messages::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.25);
      }

      /* ç§»åŠ¨ç«¯å“åº”å¼ */
      @media (max-width: 600px) {
        header { padding: 10px 12px; }
        header h1 { font-size: 16px; }
        header .subtitle { font-size: 11px; }
        .name-bar { padding: 8px 12px; }
        #messages { padding: 12px; gap: 8px; }
        #messages .msg .bubble { max-width: 82%; font-size: 15px; padding: 9px 12px; }
        form { padding: 8px 12px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
      <header>
        <div class="title">
          <h1>æ‚„æ‚„è¯ <span class="user-count" id="userCount"></span></h1>
          <div class="subtitle">ğŸ”’ ç«¯åˆ°ç«¯åŠ å¯†è¯·æ”¾å¿ƒè¯´</div>
        </div>
        <div class="status-indicator" id="status" style="display:none;">å·²è¿æ¥</div>
      </header>

      <!-- è®¤è¯ç•Œé¢ -->
      <div id="auth" style="display:none;">
        <div class="lock-icon">ğŸ”</div>
        <div class="row">
          <label>æˆ¿é—´å¯†ç </label>
          <input id="password" type="password" placeholder="è¯·è¾“å…¥æˆ¿é—´å¯†ç " autocomplete="off" />
          <button id="joinBtn">è¿›å…¥æ‚„æ‚„è¯</button>
          <div class="status-text" id="authStatus"></div>
        </div>
      </div>

      <!-- èŠå¤©ä¸»ç•Œé¢ -->
      <div id="chat" style="display:none;">
        <div class="name-bar">
          <label>æ˜µç§°</label>
          <input id="name" type="text" placeholder="ä½ çš„æ˜µç§°" autocomplete="off" />
        </div>
        <div id="messages"></div>
        <form id="form">
          <input id="input" type="text" placeholder="iMessage" autocomplete="off" />
          <button type="submit">å‘é€</button>
        </form>
      </div>
    </div>

    <script>
      // åŠ¨æ€è§†å£é«˜åº¦ä¿®æ­£ï¼šåœ¨ç§»åŠ¨ç«¯é¿å…åº•éƒ¨å‡ºç°å¤§ç©ºç™½
      (function(){
        function setAppVh(){
          document.documentElement.style.setProperty('--app-vh', window.innerHeight + 'px');
        }
        setAppVh();
        if (window.visualViewport) {
          visualViewport.addEventListener('resize', setAppVh);
          visualViewport.addEventListener('scroll', setAppVh);
        }
        window.addEventListener('resize', setAppVh);
        window.addEventListener('orientationchange', setAppVh);
      })();

      const authDiv = document.getElementById('auth');
      const chatDiv = document.getElementById('chat');
      const passwordEl = document.getElementById('password');
      const joinBtn = document.getElementById('joinBtn');
      const authStatusEl = document.getElementById('authStatus');
      const messages = document.getElementById('messages');
      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const nameEl = document.getElementById('name');
      const statusEl = document.getElementById('status');
      const userCountEl = document.getElementById('userCount');

      const store = window.localStorage;
      let clientId = store.getItem('clientId');
      if (!clientId) {
        clientId = (Math.random().toString(36).slice(2, 10) + Date.now().toString(36)).slice(0, 12);

	      // è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ï¼Œè‡ªåŠ¨æ»šåˆ°æœ€åº•éƒ¨ï¼ˆé…åˆç§»åŠ¨ç«¯è½¯é”®ç›˜ï¼‰
	      input.addEventListener('focus', () => {
	        setTimeout(() => { messages.scrollTop = messages.scrollHeight; }, 0);
	      });

        store.setItem('clientId', clientId);
      }
      function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i))>>>0; } return h; }
      function nicknameFromId(id){
        const adjs=['å¯çˆ±','æœºæ™º','å‹‡æ•¢','æ•æ·','å¿«ä¹','ä½è°ƒ','é—ªäº®','å†·é™','çƒ­æƒ…','é¡½çš®','ä¼˜é›…','é è°±','æ·¡å®š','çµå·§','ç¨³é‡','é˜³å…‰'];
        const animals=['ç‹ç‹¸','ç†ŠçŒ«','æµ·è±š','å°é¹¿','èœ—ç‰›','éº’éºŸ','çŒ«å’ª','é²¸é±¼','çŒè±¹','äº‘é›€','å¤©é¹…','éº‹é¹¿','ä¼é¹…','ç„ç‹','é£é©¬','é•¿é¢ˆé¹¿'];
        const h=hash(id); return adjs[h%adjs.length] + animals[(h>>>8)%animals.length] + String(h%100).padStart(2,'0');
      }
      if (!store.getItem('name')) {
        store.setItem('name', nicknameFromId(clientId));
      }
      nameEl.value = store.getItem('name') || '';
      nameEl.addEventListener('input', () => store.setItem('name', nameEl.value));

      let ws = null;
      let encryptionKey = null; // åŠ å¯†å¯†é’¥

      // ä»å¯†ç æ´¾ç”ŸåŠ å¯†å¯†é’¥
      async function deriveKey(password) {
        const encoder = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
          'raw',
          encoder.encode(password),
          { name: 'PBKDF2' },
          false,
          ['deriveBits', 'deriveKey']
        );
        return crypto.subtle.deriveKey(
          {
            name: 'PBKDF2',
            salt: encoder.encode('chat-room-salt-2025'),
            iterations: 100000,
            hash: 'SHA-256'
          },
          keyMaterial,
          { name: 'AES-GCM', length: 256 },
          false,
          ['encrypt', 'decrypt']
        );
      }

      // åŠ å¯†æ¶ˆæ¯
      async function encryptMessage(text) {
        const encoder = new TextEncoder();
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encrypted = await crypto.subtle.encrypt(
          { name: 'AES-GCM', iv },
          encryptionKey,
          encoder.encode(text)
        );
        // è¿”å› base64(iv + ciphertext)
        const combined = new Uint8Array(iv.length + encrypted.byteLength);
        combined.set(iv, 0);
        combined.set(new Uint8Array(encrypted), iv.length);
        return btoa(String.fromCharCode(...combined));
      }

      // è§£å¯†æ¶ˆæ¯
      async function decryptMessage(ciphertext) {
        try {
          const combined = Uint8Array.from(atob(ciphertext), c => c.charCodeAt(0));
          const iv = combined.slice(0, 12);
          const data = combined.slice(12);
          const decrypted = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv },
            encryptionKey,
            data
          );
          return new TextDecoder().decode(decrypted);
        } catch (e) {
          return '[è§£å¯†å¤±è´¥]';
        }
      }

      const savedPassword = store.getItem('roomPassword');
      if (savedPassword) {
        connectWithPassword(savedPassword);
      } else {
        authDiv.style.display = 'block';
      }

      joinBtn.addEventListener('click', () => {
        const password = passwordEl.value.trim();
        if (!password) {
          authStatusEl.textContent = 'è¯·è¾“å…¥å¯†ç ';
          authStatusEl.style.color = 'red';
          return;
        }
        connectWithPassword(password);
      });

      passwordEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') joinBtn.click();
      });

      async function connectWithPassword(password) {
        authStatusEl.textContent = 'æ­£åœ¨ç”ŸæˆåŠ å¯†å¯†é’¥â€¦';
        authStatusEl.style.color = '#666';

        // æ´¾ç”ŸåŠ å¯†å¯†é’¥
        encryptionKey = await deriveKey(password);

        authStatusEl.textContent = 'æ­£åœ¨è¿æ¥â€¦';

        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        const qs = new URLSearchParams({
          id: clientId,
          name: nameEl.value || '',
          password: password
        }).toString();
        ws = new WebSocket(`${proto}://${location.host}/?${qs}`);

        ws.onopen = () => {
          statusEl.style.display = 'flex';
          store.setItem('roomPassword', password);
          authDiv.style.display = 'none';
          chatDiv.style.display = 'flex';
        };

        ws.onclose = (e) => {
          statusEl.style.display = 'none';
          if (e.code === 1008) {
            authStatusEl.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
            store.removeItem('roomPassword');
            authDiv.style.display = 'flex';
            chatDiv.style.display = 'none';
          }
        };

        ws.onerror = () => {
          statusEl.style.display = 'none';
          authStatusEl.textContent = 'è¿æ¥å¤±è´¥';
        };

        ws.onmessage = async (e) => {
          try {
            const m = JSON.parse(e.data);
            if (m.type === 'error') {
              authStatusEl.textContent = m.text;
              store.removeItem('roomPassword');
              return;
            }
            if (m.type === 'userCount') {
              // æ›´æ–°åœ¨çº¿äººæ•°
              userCountEl.textContent = `(${m.count})`;
              return;
            }
            if (m.type === 'history') {
              // åŠ è½½å†å²æ¶ˆæ¯
              if (m.messages && m.messages.length > 0) {
                addLine('--- å†å²æ¶ˆæ¯ ---', 'system');
                for (const msg of m.messages) {
                  const who = msg.name ? msg.name : `#${msg.from}`;
                  const isMe = msg.from === clientId;
                  const plaintext = await decryptMessage(msg.text);
                  addMessage(who, plaintext, isMe);
                }
                addLine('--- ä»¥ä¸Šæ˜¯å†å²æ¶ˆæ¯ ---', 'system');
              }
              return;
            }
            if (m.type === 'system') return addLine(`ã€ç³»ç»Ÿã€‘${m.text}`, 'system');
            if (m.type === 'message') {
              const who = m.name ? m.name : `#${m.from}`;
              const isMe = m.from === clientId;
              // è§£å¯†æ¶ˆæ¯
              const plaintext = await decryptMessage(m.text);
              return addMessage(who, plaintext, isMe);
            }
          } catch (_) {
            addLine(String(e.data));
          }
        };
      }

      function addLine(text, cls) {
        const div = document.createElement('div');
        if (cls) div.className = cls;
        div.textContent = text;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }

      function addMessage(who, text, isMe) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg ' + (isMe ? 'right' : 'left');

        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        if (!isMe) {
          const nameSpan = document.createElement('div');
          nameSpan.className = 'name';
          nameSpan.textContent = who;
          bubble.appendChild(nameSpan);
        }

        const textSpan = document.createElement('div');
        textSpan.textContent = text;
        bubble.appendChild(textSpan);

        msgDiv.appendChild(bubble);
        messages.appendChild(msgDiv);
        messages.scrollTop = messages.scrollHeight;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;
        // åŠ å¯†æ¶ˆæ¯
        const ciphertext = await encryptMessage(text);
        const payload = { type: 'text', text: ciphertext, name: nameEl.value.trim() || undefined };
        ws.send(JSON.stringify(payload));
        input.value = '';
      });
    </script>
  </body>
</html>
