<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0a84ff" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="æ‚„æ‚„è¯" />

    <title>æ‚„æ‚„è¯</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        width: 100%;
        height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow: hidden;
      }

      /* ä¸»å®¹å™¨ï¼šå®Œå…¨å¡«å……è§†å£ */
      #app {
        width: 100%;
        max-width: 800px;
        height: var(--app-vh, 100vh);
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        background: #f2f2f7;
        position: relative;
      }

      /* é¡¶éƒ¨å¯¼èˆªæ  */
      header {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: rgba(242, 242, 247, 0.95);
        backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 0.5px solid rgba(60, 60, 67, 0.12);
        z-index: 10;
      }

      header .title {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      header h1 {
        font-size: 17px;
        font-weight: 600;
        color: #000;
        letter-spacing: -0.4px;
      }

      header .subtitle {
        font-size: 12px;
        color: #8e8e93;
        font-weight: 400;
      }

      header .right-section {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      header .status-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #34c759;
        font-weight: 500;
      }

      header .status-indicator::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #34c759;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      header .dissolve-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        background: #ff3b30;
        color: #fff;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
        white-space: nowrap;
      }

      header .dissolve-btn:hover {
        opacity: 0.9;
      }

      header .dissolve-btn:active {
        opacity: 0.7;
      }

      /* æ¨¡æ€æ¡†é®ç½© */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease-out;
      }

      .modal-overlay.show {
        display: flex;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      /* æ¨¡æ€æ¡†å†…å®¹ */
      .modal {
        background: #fff;
        border-radius: 14px;
        width: 90%;
        max-width: 320px;
        overflow: hidden;
        animation: slideUp 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .modal-header {
        padding: 20px 16px 12px;
        text-align: center;
      }

      .modal-title {
        font-size: 17px;
        font-weight: 600;
        color: #000;
        margin-bottom: 8px;
      }

      .modal-message {
        font-size: 13px;
        color: #8e8e93;
        line-height: 1.4;
      }

      .modal-actions {
        border-top: 0.5px solid rgba(60, 60, 67, 0.12);
        display: flex;
      }

      .modal-btn {
        flex: 1;
        padding: 14px;
        border: none;
        background: transparent;
        font-size: 17px;
        font-weight: 400;
        cursor: pointer;
        transition: background 0.2s;
      }

      .modal-btn:active {
        background: rgba(0, 0, 0, 0.05);
      }

      .modal-btn + .modal-btn {
        border-left: 0.5px solid rgba(60, 60, 67, 0.12);
      }

      .modal-btn.cancel {
        color: #007aff;
      }

      .modal-btn.danger {
        color: #ff3b30;
        font-weight: 600;
      }

      /* åœ¨çº¿äººæ•° */
      header .user-count {
        font-size: 13px;
        color: #8e8e93;
        font-weight: 500;
      }

      /* è®¤è¯ç•Œé¢ */
      #auth {
        flex: 1 1 auto;
        display: none; /* åˆå§‹éšè—ï¼Œé¿å…åˆ·æ–°æ—¶é—ªç° */
        flex-direction: column;
        align-items: center;
        padding: 32px 20px;
        background: #fff;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch; /* iOS å¹³æ»‘æ»šåŠ¨ */
      }

      #auth .content-wrapper {
        width: 100%;
        max-width: 320px;
        margin: auto 0; /* å‚ç›´å±…ä¸­ï¼Œä½†å…è®¸æ»šåŠ¨ */
      }

      #auth .content-wrapper .lock-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.8;
        text-align: center;
      }

      #auth .row {
        width: 100%;
        max-width: 320px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      #auth .title {
        font-size: 22px;
        font-weight: 600;
        color: #000;
        text-align: center;
        margin-bottom: 8px;
      }

      #auth .description {
        font-size: 14px;
        color: #8e8e93;
        text-align: center;
        margin-bottom: 16px;
        line-height: 1.4;
      }

      #auth label {
        font-size: 15px;
        color: #000;
        font-weight: 500;
      }

      #auth input {
        width: 100%;
        padding: 14px 16px;
        border: none;
        border-radius: 12px;
        background: #f2f2f7;
        font-size: 17px;
        outline: none;
        transition: background 0.2s;
      }

      #auth input:focus {
        background: #e5e5ea;
      }

      #auth button {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 12px;
        background: #007aff;
        color: #fff;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.1s;
        margin-top: 8px;
      }

      #auth button:hover {
        opacity: 0.9;
      }

      #auth button:active {
        opacity: 0.7;
        transform: scale(0.98);
      }

      #auth button.secondary {
        background: #f2f2f7;
        color: #007aff;
        margin-top: 12px;
      }

      #auth .divider {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 20px 0;
        color: #8e8e93;
        font-size: 14px;
      }

      #auth .divider::before,
      #auth .divider::after {
        content: '';
        flex: 1;
        height: 0.5px;
        background: rgba(60, 60, 67, 0.12);
      }

      #auth .status-text {
        margin-top: 12px;
        font-size: 14px;
        color: #ff3b30;
        text-align: center;
        min-height: 20px;
      }

      #auth .room-info {
        margin-top: 16px;
        padding: 12px 16px;
        background: #f2f2f7;
        border-radius: 12px;
        font-size: 14px;
        color: #8e8e93;
        text-align: center;
      }

      #auth .room-info strong {
        color: #000;
        font-weight: 600;
      }

      /* èŠå¤©ä¸»ç•Œé¢å®¹å™¨ */
      #chat {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        min-height: 0;
        background: #fff;
      }

      /* æ˜µç§°ç¼–è¾‘æ  */
      .name-bar {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        background: #f2f2f7;
        border-bottom: 0.5px solid rgba(60, 60, 67, 0.12);
      }

      .name-bar label {
        font-size: 14px;
        color: #8e8e93;
        font-weight: 500;
        white-space: nowrap;
      }

      .name-bar input {
        flex: 1 1 auto;
        padding: 9px 12px;
        border: none;
        border-radius: 8px;
        background: #fff;
        font-size: 16px;
        outline: none;
        transition: box-shadow 0.2s;
      }

      .name-bar input:focus {
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
      }

      .name-bar button {
        padding: 8px 14px;
        border: none;
        border-radius: 8px;
        background: #007aff;
        color: #fff;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
        white-space: nowrap;
      }

      .name-bar button:hover {
        opacity: 0.9;
      }

      .name-bar button:active {
        opacity: 0.7;
      }

      /* æ¶ˆæ¯æ»šåŠ¨åŒºåŸŸ */
      #messages {
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 16px;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 10px;
        -webkit-overflow-scrolling: touch;
      }

      /* ç³»ç»Ÿæ¶ˆæ¯ - ç¼©å°å æ¯” */
      #messages .system {
        align-self: center;
        color: #8e8e93;
        font-size: 11px;
        text-align: center;
        padding: 3px 8px;
        background: rgba(142, 142, 147, 0.05);
        border-radius: 8px;
        max-width: 70%;
        margin: 2px 0;
      }

      /* æ¶ˆæ¯æ°”æ³¡å®¹å™¨ */
      #messages .msg {
        display: flex;
        flex-direction: column;
        animation: slideIn 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(8px) scale(0.96);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      #messages .msg.left {
        align-items: flex-start;
      }

      #messages .msg.right {
        align-items: flex-end;
      }

      /* æ˜µç§°æ ‡ç­¾ */
      #messages .msg .name {
        font-size: 12px;
        color: #8e8e93;
        margin-bottom: 4px;
        padding: 0 4px;
        font-weight: 500;
      }

      /* æ¶ˆæ¯æ°”æ³¡ */
      #messages .msg .bubble {
        max-width: 75%;
        min-width: 48px;
        padding: 10px 14px;
        border-radius: 18px;
        word-wrap: break-word;
        word-break: break-word;
        line-height: 1.42;
        font-size: 16px;
        position: relative;
      }

      #messages .msg.left .bubble {
        /* èƒŒæ™¯è‰²å°†ç”± JavaScript åŠ¨æ€è®¾ç½® */
        color: #fff;
        border-bottom-left-radius: 4px;
      }

      #messages .msg.right .bubble {
        background: #007aff;
        color: #fff;
        border-bottom-right-radius: 4px;
      }

      /* åº•éƒ¨è¾“å…¥æ  */
      form {
        flex: 0 0 auto;
        display: flex;
        align-items: flex-end;
        gap: 8px;
        padding: 10px 16px;
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
        background: #f2f2f7;
        border-top: 0.5px solid rgba(60, 60, 67, 0.12);
      }

      #input {
        flex: 1 1 auto;
        min-height: 36px;
        max-height: 100px;
        padding: 8px 14px;
        border: none;
        border-radius: 18px;
        background: #fff;
        font-size: 16px;
        line-height: 1.4;
        outline: none;
        resize: none;
        font-family: inherit;
        transition: box-shadow 0.2s;
      }

      #input:focus {
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.15);
      }

      form button {
        flex: 0 0 auto;
        padding: 8px 18px;
        border: none;
        border-radius: 18px;
        background: #007aff;
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.1s;
        white-space: nowrap;
        min-height: 36px;
      }

      form button:hover {
        opacity: 0.9;
      }

      form button:active {
        opacity: 0.7;
        transform: scale(0.96);
      }

      /* æ»šåŠ¨æ¡æ ·å¼ (webkit) */
      #messages::-webkit-scrollbar {
        width: 4px;
      }
      #messages::-webkit-scrollbar-track {
        background: transparent;
      }
      #messages::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
        border-radius: 2px;
      }
      #messages::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.25);
      }

      /* ç§»åŠ¨ç«¯å“åº”å¼ */
      @media (max-width: 600px) {
        header { padding: 10px 12px; }
        header h1 { font-size: 16px; }
        header .subtitle { font-size: 11px; }
        .name-bar { padding: 8px 12px; }
        #messages { padding: 12px; gap: 8px; }
        #messages .msg .bubble { max-width: 82%; font-size: 15px; padding: 9px 12px; }
        form { padding: 8px 12px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
      <header>
        <div class="title">
          <h1>æ‚„æ‚„è¯ <span class="user-count" id="userCount"></span></h1>
          <div class="subtitle">ğŸ”’ ç«¯åˆ°ç«¯åŠ å¯†è¯·æ”¾å¿ƒè¯´</div>
        </div>
        <div class="right-section">
          <button id="dissolveBtn" class="dissolve-btn" style="display:none;">è§£æ•£æˆ¿é—´</button>
          <div class="status-indicator" id="status" style="display:none;">å·²è¿æ¥</div>
        </div>
      </header>

      <!-- è§£æ•£æˆ¿é—´ç¡®è®¤æ¨¡æ€æ¡† -->
      <div class="modal-overlay" id="dissolveModal">
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title">è§£æ•£æˆ¿é—´</div>
            <div class="modal-message">ç¡®å®šè¦è§£æ•£æˆ¿é—´å—ï¼Ÿæ‰€æœ‰æˆå‘˜å°†è¢«ç§»é™¤ï¼ŒèŠå¤©è®°å½•å°†è¢«æ¸…ç©ºã€‚</div>
          </div>
          <div class="modal-actions">
            <button class="modal-btn cancel" id="modalCancel">å–æ¶ˆ</button>
            <button class="modal-btn danger" id="modalConfirm">è§£æ•£</button>
          </div>
        </div>
      </div>

      <!-- è®¤è¯ç•Œé¢ -->
      <div id="auth">
        <div class="content-wrapper">
          <div class="lock-icon">ğŸ”</div>
          <div class="row">
            <div class="title">æ¬¢è¿æ¥åˆ°æ‚„æ‚„è¯</div>
            <div class="description">åˆ›å»ºæ–°æˆ¿é—´æˆ–åŠ å…¥å·²æœ‰æˆ¿é—´å¼€å§‹èŠå¤©</div>

            <button id="createRoomBtn">åˆ›å»ºæ–°æˆ¿é—´</button>

            <div class="divider">æˆ–</div>

            <label>åŠ å…¥å·²æœ‰æˆ¿é—´</label>
            <input id="roomPassword" type="text" placeholder="è¾“å…¥æˆ¿é—´å¯†ç " autocomplete="off" />
            <button id="joinRoomBtn" class="secondary">åŠ å…¥æˆ¿é—´</button>

            <div class="status-text" id="authStatus"></div>
            <div class="room-info" id="roomInfo" style="display:none;"></div>
          </div>
        </div>
      </div>

      <!-- èŠå¤©ä¸»ç•Œé¢ -->
      <div id="chat" style="display:none;">
        <div class="name-bar">
          <label>æ˜µç§°</label>
          <input id="name" type="text" placeholder="ä½ çš„æ˜µç§°" autocomplete="off" />
          <button id="inviteBtn">é‚€è¯·</button>
        </div>
        <div id="messages"></div>
        <form id="form">
          <input id="input" type="text" placeholder="iMessage" autocomplete="off" enterkeyhint="send" autocapitalize="off" autocorrect="off" spellcheck="false" />
          <button type="button" id="sendBtn">å‘é€</button>
        </form>
      </div>
    </div>

    <script>
      // åŠ¨æ€è§†å£é«˜åº¦ä¿®æ­£ï¼šåœ¨ç§»åŠ¨ç«¯é¿å…åº•éƒ¨å‡ºç°å¤§ç©ºç™½
      (function(){
        function setAppVh(){
          document.documentElement.style.setProperty('--app-vh', window.innerHeight + 'px');
        }
        setAppVh();
        if (window.visualViewport) {
          visualViewport.addEventListener('resize', setAppVh);
          visualViewport.addEventListener('scroll', setAppVh);
        }
        window.addEventListener('resize', setAppVh);
        window.addEventListener('orientationchange', setAppVh);
      })();

      const authDiv = document.getElementById('auth');
      const chatDiv = document.getElementById('chat');
      const roomPasswordEl = document.getElementById('roomPassword');
      const createRoomBtn = document.getElementById('createRoomBtn');
      const joinRoomBtn = document.getElementById('joinRoomBtn');
      const authStatusEl = document.getElementById('authStatus');
      const roomInfoEl = document.getElementById('roomInfo');
      const messages = document.getElementById('messages');
      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const nameEl = document.getElementById('name');
      const statusEl = document.getElementById('status');
      const userCountEl = document.getElementById('userCount');
      const sendBtn = document.getElementById('sendBtn');

      // é¿å…ç‚¹å‡»â€œå‘é€â€æŒ‰é’®æ—¶è®©è¾“å…¥æ¡†å¤±ç„¦ï¼ŒåŒæ—¶åœ¨è§¦æ‘¸è®¾å¤‡ç›´æ¥å‘é€
      if (sendBtn) {
        // æ¡Œé¢ç«¯ï¼šæŒ‰ä¸‹æ—¶ä¿æŒè¾“å…¥æ¡†ç„¦ç‚¹ï¼Œç‚¹å‡»æ—¶å‘é€
        sendBtn.addEventListener('mousedown', (e) => {
          e.preventDefault();
          input.focus({ preventScroll: true });
        }, { passive: false });
        // ç§»åŠ¨ç«¯ï¼šè§¦æ‘¸å¼€å§‹å³å‘é€ï¼Œé¿å… click è¢«é˜»æ–­ä¸”ä¿æŒé”®ç›˜
        sendBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          input.focus({ preventScroll: true });
          // ç›´æ¥å‘é€
          if (typeof sendMessage === 'function') sendMessage();
        }, { passive: false });
      }

      const store = window.localStorage;
      let clientId = store.getItem('clientId');
      if (!clientId) {
        clientId = (Math.random().toString(36).slice(2, 10) + Date.now().toString(36)).slice(0, 12);
        store.setItem('clientId', clientId);
      }

      // æ»šåŠ¨åˆ°åº•éƒ¨çš„è¾…åŠ©å‡½æ•°
      function scrollToBottom() {
        messages.scrollTop = messages.scrollHeight;
      }

      // è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ï¼Œè‡ªåŠ¨æ»šåˆ°æœ€åº•éƒ¨ï¼ˆé…åˆç§»åŠ¨ç«¯è½¯é”®ç›˜ï¼‰
      input.addEventListener('focus', () => {
        // å¤šæ¬¡å°è¯•æ»šåŠ¨ï¼Œå› ä¸ºé”®ç›˜å¼¹å‡ºæœ‰å»¶è¿Ÿ
        setTimeout(scrollToBottom, 100);
        setTimeout(scrollToBottom, 300);
        setTimeout(scrollToBottom, 500);
      });

      // ç›‘å¬ visualViewport å˜åŒ–ï¼ˆé”®ç›˜å¼¹å‡º/æ”¶èµ·ï¼‰
      if (window.visualViewport) {
        visualViewport.addEventListener('resize', () => {
          // å¦‚æœè¾“å…¥æ¡†æœ‰ç„¦ç‚¹ï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
          if (document.activeElement === input) {
            setTimeout(scrollToBottom, 100);
          }
        });
      }

      // ç³»ç»Ÿæ¶ˆæ¯å»é‡ï¼šè®°å½•æœ€è¿‘çš„ç³»ç»Ÿæ¶ˆæ¯å’Œæ—¶é—´æˆ³
      const recentSystemMessages = new Map(); // key: æ¶ˆæ¯æ–‡æœ¬, value: æ—¶é—´æˆ³
      const SYSTEM_MSG_DEDUPE_WINDOW = 10000; // 10ç§’å†…ç›¸åŒæ¶ˆæ¯å»é‡
      function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i))>>>0; } return h; }
      function nicknameFromId(id){
        const prefixes = ['åœ¨é€ƒ', 'é€€å½¹', 'èµ„æ·±', 'è§ä¹ ', 'å®ä¹ ', 'ä¸´æ—¶', 'å…¼èŒ', 'å…¨èŒ', 'é¦–å¸­', 'å¾¡ç”¨', 'ä¸“ä¸š', 'ä¸šä½™', 'ç¥ç§˜', 'éšè—', 'ä¼ è¯´ä¸­çš„', 'è¿·è·¯çš„', 'ç†¬å¤œ', 'æ‘¸é±¼', 'åˆ’æ°´', 'æ½œæ°´'];
        const roles = ['å…¬ä¸»', 'æ‰“å·¥äºº', 'ç¤¾ç•œ', 'ç½‘ç˜¾å°‘å¹´', 'ç†¬å¤œå† å†›', 'å¹²é¥­äºº', 'åƒç“œç¾¤ä¼—', 'é”®ç›˜ä¾ ', 'è¯ç—¨', 'ç¤¾æ', 'è‚¥å®…', 'å’¸é±¼', 'å·¥å…·äºº', 'æŸ æª¬ç²¾', 'æ ç²¾', 'å·ç‹', 'èººå¹³å¤§å¸ˆ', 'æ‘†çƒ‚ä¸“å®¶', 'è¿½æ˜Ÿæ—', 'å¤œçŒ«å­'];
        const h = hash(id);
        return prefixes[h % prefixes.length] + roles[(h >>> 8) % roles.length] + String(h % 100).padStart(2, '0');
      }
      if (!store.getItem('name')) {
        store.setItem('name', nicknameFromId(clientId));
      }
      nameEl.value = store.getItem('name') || '';
      nameEl.addEventListener('input', () => store.setItem('name', nameEl.value));

      let ws = null;
      let encryptionKey = null; // åŠ å¯†å¯†é’¥
      let currentRoomId = null; // å½“å‰æˆ¿é—´ID
      let isRoomOwner = false; // æ˜¯å¦ä¸ºæˆ¿ä¸»

      // è¿æ¥é‡è¿çŠ¶æ€
      let reconnectTimer = null;
      let reconnectAttempts = 0;
      let lastActivityAt = Date.now();

      function isWsOpen() {
        return ws && ws.readyState === WebSocket.OPEN;
      }

      function setStatus(text) {
        statusEl.style.display = 'flex';
        statusEl.textContent = text;
      }

      function clearReconnectTimer(){
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }
      }

      function scheduleReconnect(immediate = false) {
        if (!currentRoomId) return; // æœªåŠ å…¥æˆ¿é—´æ— éœ€é‡è¿
        if (isWsOpen()) return; // å·²è¿æ¥
        if (reconnectTimer) return; // å·²æœ‰å®šæ—¶å™¨
        const base = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
        const delay = immediate ? 0 : base;
        setStatus('é‡è¿ä¸­â€¦');
        reconnectTimer = setTimeout(() => {
          reconnectTimer = null;
          reconnectAttempts++;
          connectToRoom(currentRoomId);
        }, delay);
      }

      function onConnected(){
        reconnectAttempts = 0;
        clearReconnectTimer();
        setStatus('å·²è¿æ¥');
        if (sendBtn) sendBtn.disabled = false;
      }

      // å‰åå°åˆ‡æ¢ & ç½‘ç»œå˜åŒ–ï¼šæ¢å¤æ—¶å°è¯•é‡è¿
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          if (!isWsOpen()) scheduleReconnect(true);
        }
      });
      window.addEventListener('pageshow', () => {
        if (!isWsOpen()) scheduleReconnect(true);
      });
      window.addEventListener('online', () => scheduleReconnect(true));
      // è®°å½•æœ€è¿‘æ´»åŠ¨
      const markActivity = () => (lastActivityAt = Date.now());

      // ç¦»çº¿å‘é€é˜Ÿåˆ—
      // ç»“æ„ï¼š{ roomId: string, payload: { type, text, name } }
      let sendQueue = [];
      function flushQueue(){
        if (!isWsOpen() || sendQueue.length === 0) return;
        const pending = sendQueue.splice(0);
        const remain = [];
        let sent = 0;
        for (const item of pending) {
          if (item.roomId !== currentRoomId) { remain.push(item); continue; }
          try { ws.send(JSON.stringify(item.payload)); sent++; }
          catch (e) { // å‘é€å¤±è´¥ï¼ŒæŠŠå½“å‰ä»¥åŠå‰©ä½™çš„å¡å›é˜Ÿåˆ—å¹¶é€€å‡º
            remain.push(item, ...pending.slice(pending.indexOf(item)+1));
            break;
          }
        }
        if (remain.length) sendQueue = remain.concat(sendQueue);
        if (sent > 0) addLine(`å·²å‘é€æ’é˜Ÿçš„${sent}æ¡æ¶ˆæ¯`, 'system');
      }

      // ç”Ÿæˆéšæœºæˆ¿é—´å¯†ç 
      function generateRoomPassword() {
        const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        let password = '';
        for (let i = 0; i < 8; i++) {
          password += chars[Math.floor(Math.random() * chars.length)];
        }
        return password;
      }

      // ä» URL è·å–æˆ¿é—´å‚æ•°
      function getRoomFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('room');
      }

      // ç”Ÿæˆé‚€è¯·é“¾æ¥
      function getInviteLink(roomId) {
        const url = new URL(window.location.origin + window.location.pathname);
        url.searchParams.set('room', roomId);
        return url.toString();
      }

      // å½’ä¸€åŒ–æˆ¿é—´IDï¼šå¦‚æœç”¨æˆ·ç²˜è´´çš„æ˜¯å®Œæ•´é“¾æ¥ï¼Œæå–å…¶ä¸­çš„ room å‚æ•°
      function normalizeRoomId(input) {
        if (!input) return input;
        try {
          const u = new URL(input);
          const r = u.searchParams.get('room');
          return r || input;
        } catch (_) {
          return input;
        }
      }

      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (e) {
          // é™çº§æ–¹æ¡ˆ
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          const success = document.execCommand('copy');
          document.body.removeChild(textarea);
          return success;
        }
      }

      // ä»å¯†ç æ´¾ç”ŸåŠ å¯†å¯†é’¥
      async function deriveKey(password) {
        const encoder = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
          'raw',
          encoder.encode(password),
          { name: 'PBKDF2' },
          false,
          ['deriveBits', 'deriveKey']
        );
        return crypto.subtle.deriveKey(
          {
            name: 'PBKDF2',
            salt: encoder.encode('chat-room-salt-2025'),
            iterations: 100000,
            hash: 'SHA-256'
          },
          keyMaterial,
          { name: 'AES-GCM', length: 256 },
          false,
          ['encrypt', 'decrypt']
        );
      }

      // åŠ å¯†æ¶ˆæ¯
      async function encryptMessage(text) {
        const encoder = new TextEncoder();
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encrypted = await crypto.subtle.encrypt(
          { name: 'AES-GCM', iv },
          encryptionKey,
          encoder.encode(text)
        );
        // è¿”å› base64(iv + ciphertext)
        const combined = new Uint8Array(iv.length + encrypted.byteLength);
        combined.set(iv, 0);
        combined.set(new Uint8Array(encrypted), iv.length);
        return btoa(String.fromCharCode(...combined));
      }

      // è§£å¯†æ¶ˆæ¯
      async function decryptMessage(ciphertext) {
        try {
          const combined = Uint8Array.from(atob(ciphertext), c => c.charCodeAt(0));
          const iv = combined.slice(0, 12);
          const data = combined.slice(12);
          const decrypted = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv },
            encryptionKey,
            data
          );
          return new TextDecoder().decode(decrypted);
        } catch (e) {
          return '[è§£å¯†å¤±è´¥]';
        }
      }

      // æ£€æŸ¥ URL å‚æ•°æˆ–æœ¬åœ°å­˜å‚¨
      const urlRoom = getRoomFromURL();
      const savedRoom = store.getItem('currentRoom');

      // ğŸ”§ ä¿®å¤ï¼šURL å‚æ•°ä¼˜å…ˆäº localStorageï¼ˆé€šè¿‡é“¾æ¥åˆ†äº«æ—¶æ­£ç¡®åŠ å…¥æˆ¿é—´ï¼‰
      if (urlRoom) {
        // é€šè¿‡é‚€è¯·é“¾æ¥è®¿é—®ï¼Œè‡ªåŠ¨åŠ å…¥è¯¥æˆ¿é—´
        // å¦‚æœ URL æˆ¿é—´ä¸ localStorage ä¸åŒï¼Œæ¸…é™¤æ—§æˆ¿é—´è®°å½•
        if (savedRoom && savedRoom !== urlRoom) {
          store.removeItem('currentRoom');
        }

        // ğŸ”§ é‡è¦ï¼šæ¸…é™¤ URL å‚æ•°ï¼Œé˜²æ­¢åˆ·æ–°æ—¶é‡å¤ä½¿ç”¨
        window.history.replaceState({}, document.title, window.location.pathname);

        roomPasswordEl.value = urlRoom;
        statusEl.style.display = 'flex';
        statusEl.textContent = 'æ­£åœ¨è¿æ¥â€¦';
        connectToRoom(urlRoom);
      } else if (savedRoom) {
        // ä¼˜å…ˆè‡ªåŠ¨é‡è¿ä¸Šæ¬¡çš„æˆ¿é—´ï¼ˆåˆ·æ–°é¡µé¢ä¿æŒåœ¨çº¿ï¼‰
        // ä¸æ˜¾ç¤ºè®¤è¯é¡µé¢ï¼Œé¿å…é—ªçƒï¼›ä»…åœ¨ header æ˜¾ç¤ºè¿æ¥çŠ¶æ€
        statusEl.style.display = 'flex';
        statusEl.textContent = 'æ­£åœ¨è¿æ¥â€¦';
        connectToRoom(savedRoom);
      } else {
        // é¦–æ¬¡è®¿é—®ï¼Œæ˜¾ç¤ºè®¤è¯ç•Œé¢
        authDiv.style.display = 'flex';
      }

      // åˆ›å»ºæ–°æˆ¿é—´
      createRoomBtn.addEventListener('click', () => {
        const roomId = generateRoomPassword();
        const inviteLink = getInviteLink(roomId);

        roomInfoEl.innerHTML = `
          <strong>æˆ¿é—´å·²åˆ›å»ºï¼</strong><br>
          æˆ¿é—´å¯†ç ï¼š<strong>${roomId}</strong><br>
          <span style="font-size:12px;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¤åˆ¶é‚€è¯·é“¾æ¥åˆ†äº«ç»™æœ‹å‹</span>
        `;
        roomInfoEl.style.display = 'block';

        // æ·»åŠ å¤åˆ¶æŒ‰é’®
        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'å¤åˆ¶é‚€è¯·é“¾æ¥';
        copyBtn.style.marginTop = '12px';
        copyBtn.onclick = async () => {
          const success = await copyToClipboard(inviteLink);
          if (success) {
            copyBtn.textContent = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
              copyBtn.textContent = 'å¤åˆ¶é‚€è¯·é“¾æ¥';
            }, 2000);
          }
        };
        roomInfoEl.appendChild(copyBtn);

        // è‡ªåŠ¨è¿æ¥åˆ°æ–°æˆ¿é—´
        setTimeout(() => {
          connectToRoom(roomId);
        }, 1500);
      });

      // åŠ å…¥æˆ¿é—´
      joinRoomBtn.addEventListener('click', () => {
        const roomId = normalizeRoomId(roomPasswordEl.value.trim());
        if (!roomId) {
          authStatusEl.textContent = 'è¯·è¾“å…¥æˆ¿é—´å¯†ç ';
          authStatusEl.style.color = '#ff3b30';
          return;
        }
        connectToRoom(roomId);
      });

      roomPasswordEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') joinRoomBtn.click();
      });

      async function connectToRoom(roomId) {
        authStatusEl.textContent = 'æ­£åœ¨ç”ŸæˆåŠ å¯†å¯†é’¥â€¦';
        authStatusEl.style.color = '#8e8e93';

        // æ´¾ç”ŸåŠ å¯†å¯†é’¥ï¼ˆä½¿ç”¨æˆ¿é—´å¯†ç ï¼‰
        encryptionKey = await deriveKey(roomId);
        currentRoomId = roomId;

        authStatusEl.textContent = 'æ­£åœ¨è¿æ¥æˆ¿é—´â€¦';

        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        const qs = new URLSearchParams({
          id: clientId,
          name: nameEl.value || '',
          room: roomId
        }).toString();

        ws = new WebSocket(`${proto}://${location.host}/?${qs}`);

        ws.onopen = () => {
          onConnected();
          store.setItem('currentRoom', roomId);
          authDiv.style.display = 'none';
          chatDiv.style.display = 'flex';

          // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯
          document.querySelector('header .subtitle').textContent = `æˆ¿é—´: ${roomId}`;
          // é‡è¿æˆåŠŸåï¼Œå°è¯•å‘é€æ’é˜Ÿæ¶ˆæ¯
          flushQueue();
        };

        ws.onclose = (e) => {
          if (e.code === 1008) {
            authStatusEl.textContent = 'æˆ¿é—´è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç ';
            authStatusEl.style.color = '#ff3b30';
            store.removeItem('currentRoom');
            authDiv.style.display = 'flex';
            chatDiv.style.display = 'none';
            if (sendBtn) sendBtn.disabled = true;
          } else if (e.code === 1000 && e.reason === 'Room dissolved by owner') {
            // æˆ¿é—´è¢«è§£æ•£ï¼Œå·²åœ¨ roomDissolved æ¶ˆæ¯ä¸­å¤„ç†
            // è¿™é‡Œä¸éœ€è¦é¢å¤–æ“ä½œï¼Œé¿å…é‡å¤
          } else {
            // å…¶ä»–æƒ…å†µï¼šè‡ªåŠ¨é‡è¿
            scheduleReconnect(false);
          }
        };

        ws.onerror = () => {
          authStatusEl.textContent = 'è¿æ¥å¼‚å¸¸ï¼Œæ­£åœ¨é‡è¿â€¦';
          authStatusEl.style.color = '#8e8e93';
          scheduleReconnect(false);
        };

        ws.onmessage = async (e) => {
          markActivity();
          try {
            const m = JSON.parse(e.data);
            if (m.type === 'error') {
              authStatusEl.textContent = m.text;
              authStatusEl.style.color = '#ff3b30';
              store.removeItem('currentRoom');
              return;
            }
            if (m.type === 'userCount') {
              // æ›´æ–°åœ¨çº¿äººæ•°
              userCountEl.textContent = `(${m.count})`;
              return;
            }
            if (m.type === 'history') {
              // å·²æœ‰å†…å®¹æ—¶è·³è¿‡å†å²ï¼Œé¿å…é‡è¿åé‡å¤æ¸²æŸ“
              if (messages.childElementCount > 0) {
                return;
              }
              // åŠ è½½å†å²æ¶ˆæ¯
              if (m.messages && m.messages.length > 0) {
                addLine('--- å†å²æ¶ˆæ¯ ---', 'system');
                for (const msg of m.messages) {
                  const who = msg.name ? msg.name : `#${msg.from}`;
                  const isMe = msg.from === clientId;
                  const plaintext = await decryptMessage(msg.text);
                  addMessage(who, plaintext, isMe, msg.color);
                }
                addLine('--- ä»¥ä¸Šæ˜¯å†å²æ¶ˆæ¯ ---', 'system');
              }
              return;
            }
            if (m.type === 'system') {
              // æ£€æŸ¥æ˜¯å¦ä¸ºæˆ¿ä¸»
              if (m.isOwner !== undefined) {
                isRoomOwner = m.isOwner;
                const dissolveBtn = document.getElementById('dissolveBtn');
                if (isRoomOwner) {
                  dissolveBtn.style.display = 'block';
                }
              }
              return addLine(`ã€ç³»ç»Ÿã€‘${m.text}`, 'system');
            }
            if (m.type === 'roomDissolved') {
              // æˆ¿é—´è¢«è§£æ•£ - ç«‹å³æ¸…é™¤æœ¬åœ°å­˜å‚¨å’Œ URL å‚æ•°
              store.removeItem('currentRoom');
              addLine(`ã€ç³»ç»Ÿã€‘${m.text}`, 'system');
              setTimeout(() => {
                // æ¸…é™¤ URL å‚æ•°åé‡æ–°åŠ è½½
                window.history.replaceState({}, '', window.location.pathname);
                location.reload();
              }, 2000);
              return;
            }
            if (m.type === 'message') {
              const who = m.name ? m.name : `#${m.from}`;
              const isMe = m.from === clientId;
              // è§£å¯†æ¶ˆæ¯
              const plaintext = await decryptMessage(m.text);
              return addMessage(who, plaintext, isMe, m.color);
            }
          } catch (_) {
            addLine(String(e.data));
          }
        };
      }

      function addLine(text, cls) {
        // ç³»ç»Ÿæ¶ˆæ¯å»é‡é€»è¾‘
        if (cls === 'system') {
          const now = Date.now();
          const lastTime = recentSystemMessages.get(text);

          // å¦‚æœ10ç§’å†…å‡ºç°è¿‡ç›¸åŒæ¶ˆæ¯ï¼Œè·³è¿‡
          if (lastTime && (now - lastTime) < SYSTEM_MSG_DEDUPE_WINDOW) {
            return;
          }

          // è®°å½•æœ¬æ¬¡æ¶ˆæ¯æ—¶é—´
          recentSystemMessages.set(text, now);

          // æ¸…ç†è¿‡æœŸè®°å½•ï¼ˆè¶…è¿‡å»é‡çª—å£çš„æ¶ˆæ¯ï¼‰
          for (const [msg, time] of recentSystemMessages.entries()) {
            if (now - time > SYSTEM_MSG_DEDUPE_WINDOW) {
              recentSystemMessages.delete(msg);
            }
          }
        }

        const div = document.createElement('div');
        if (cls) div.className = cls;
        div.textContent = text;
        messages.appendChild(div);
        scrollToBottom();
      }

      function addMessage(who, text, isMe, color) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg ' + (isMe ? 'right' : 'left');

        // æ˜µç§°æ”¾åœ¨æ°”æ³¡å¤–é¢
        if (!isMe) {
          const nameSpan = document.createElement('div');
          nameSpan.className = 'name';
          nameSpan.textContent = who;
          msgDiv.appendChild(nameSpan);
        }

        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        // å¦‚æœä¸æ˜¯è‡ªå·±çš„æ¶ˆæ¯ï¼Œåº”ç”¨ç”¨æˆ·ä¸“å±é¢œè‰²
        if (!isMe && color) {
          bubble.style.backgroundColor = color;
        }

        const textSpan = document.createElement('div');
        textSpan.textContent = text;
        bubble.appendChild(textSpan);

        msgDiv.appendChild(bubble);
        messages.appendChild(msgDiv);
        scrollToBottom();
      }

      // é‚€è¯·æŒ‰é’®
      const inviteBtn = document.getElementById('inviteBtn');
      inviteBtn.addEventListener('click', async () => {
        if (!currentRoomId) return;
        const inviteLink = getInviteLink(currentRoomId);
        const success = await copyToClipboard(inviteLink);
        if (success) {
          inviteBtn.textContent = 'å·²å¤åˆ¶';
          setTimeout(() => {
            inviteBtn.textContent = 'é‚€è¯·';
          }, 2000);
        } else {
          alert('å¤åˆ¶å¤±è´¥ï¼Œé‚€è¯·é“¾æ¥ï¼š\n' + inviteLink);
        }
      });

      // è§£æ•£æˆ¿é—´æŒ‰é’®ä¸æ¨¡æ€æ¡†
      const dissolveBtn = document.getElementById('dissolveBtn');
      const dissolveModal = document.getElementById('dissolveModal');
      const modalCancel = document.getElementById('modalCancel');
      const modalConfirm = document.getElementById('modalConfirm');

      dissolveBtn.addEventListener('click', () => {
        if (!isRoomOwner) return;
        dissolveModal.classList.add('show');
      });

      modalCancel.addEventListener('click', () => {
        dissolveModal.classList.remove('show');
      });

      modalConfirm.addEventListener('click', () => {
        dissolveModal.classList.remove('show');
        ws.send(JSON.stringify({ type: 'dissolveRoom' }));
      });

      // ç‚¹å‡»é®ç½©å±‚å…³é—­æ¨¡æ€æ¡†
      dissolveModal.addEventListener('click', (e) => {
        if (e.target === dissolveModal) {
          dissolveModal.classList.remove('show');
        }
      });

      // æ³¨å†Œ Service Workerï¼ˆPWA å®‰è£…æ”¯æŒï¼‰
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').catch(() => {});
        });
      }

      async function sendMessage(){
        const text = input.value.trim();
        if (!text) return;
        if (!isWsOpen()) {
          // ç¦»çº¿ï¼šå°†æ¶ˆæ¯åŠ å¯†ååŠ å…¥å¾…å‘é€é˜Ÿåˆ—ï¼Œå¹¶å°è¯•é‡è¿
          const ciphertext = await encryptMessage(text);
          const payload = { type: 'text', text: ciphertext, name: nameEl.value.trim() || undefined };
          sendQueue.push({ roomId: currentRoomId, payload });
          addLine(`ç¦»çº¿ï¼Œå·²åŠ å…¥å¾…å‘é€é˜Ÿåˆ—ï¼ˆ${sendQueue.length}ï¼‰`, 'system');
          input.value = '';
          if (document.activeElement !== input) {
            input.focus({ preventScroll: true });
          }
          scheduleReconnect(true);
          setTimeout(scrollToBottom, 50);
          return;
        }
        const ciphertext = await encryptMessage(text);
        const payload = { type: 'text', text: ciphertext, name: nameEl.value.trim() || undefined };
        ws.send(JSON.stringify(payload));
        input.value = '';
        // ä¿æŒè¾“å…¥èšç„¦ï¼ˆä»…å½“ç¡®å®å¤±ç„¦æ—¶ï¼‰
        if (document.activeElement !== input) {
          input.focus({ preventScroll: true });
        }
        setTimeout(scrollToBottom, 50);
      }

      // ç¦ç”¨è¡¨å•é»˜è®¤æäº¤ï¼Œæ”¹ä¸ºæ‰‹åŠ¨å‘é€
      form.addEventListener('submit', (e) => e.preventDefault());
      if (sendBtn) sendBtn.addEventListener('click', () => { sendMessage(); });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      });
    </script>
  </body>
</html>
